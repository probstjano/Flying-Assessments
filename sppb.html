<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPPB – Short Physical Performance Battery</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 10px;
      font-size: 16px;
      max-width: 600px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      margin-top: 10px;
    }
    #result, #normwerte {
      font-weight: bold;
      margin-top: 20px;
      white-space: pre-line;
    }
    #normwerte table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #normwerte th, #normwerte td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .inline {
      display: inline-block;
      margin-right: 10px;
    }
    .nav-buttons {
      margin-top: 30px;
    }
    .nav-buttons a {
      display: inline-block;
      margin-right: 10px;
      padding: 10px 15px;
      background: #eee;
      border-radius: 8px;
      text-decoration: none;
      color: #000;
    }
    .nav-buttons a:hover {
      background: #ddd;
    }
  </style>
</head>
<body>
  <h1>SPPB – Short Physical Performance Battery</h1>
  <p>Test für physische Leistungsfähigkeit unterer Extremitäten.</p>
  <p>Eintragen mit Einzelwerte im Cenplex Behandlungsplan unter "Messung".</p>

  <form id="sppbForm">
    <h3>Balance</h3>
    <label><input type="checkbox" id="standZusammen"> Füße zusammen &gt;10 s</label>
    <label><input type="checkbox" id="semitandem"> Semitandem &gt;10 s</label>
    <label>Tandem-Zeit (Sekunden):</label>
    <input type="number" id="tandemZeit" step="0.01">

    <h3>Gehgeschwindigkeit</h3>
    <label>Gemessene Strecke:</label>
    <label class="inline"><input type="radio" name="strecke" value="3" checked> 3 m</label>
    <label class="inline"><input type="radio" name="strecke" value="4"> 4 m</label>
    <label>Zeit (Sekunden):</label>
    <input type="number" id="gehzeit" step="0.01">

    <h3>5× Sitz-Stand</h3>
    <label>Zeit (Sekunden):</label>
    <input type="number" id="sitzStand" step="0.01">

    <button type="button" onclick="calculateSPPB()">✅ Score berechnen</button>
    <button type="button" onclick="downloadPDF()">📄 Als PDF speichern</button>
  </form>

  <p id="result"></p>

  <div id="ageSection" class="hidden">
    <label>Alter der Person:</label>
    <input type="number" id="age" min="0" max="120">
    <button type="button" onclick="toggleNorms()">📊 Normwerte anzeigen</button>
    <div id="normwerte" class="hidden"></div>
  </div>

  <div class="nav-buttons">
    <a href="standard.html">⬅️ Zurück zu Standard-Assessments</a>
    <a href="index.html">🏠 Zur Startseite</a>
  </div>

  <script>
    // Original Bohannon-Mittelwerte
    const bohannonNorms = [
      { range: "65–69", mean: "13.3 s", percentUnable: "15.1 %" },
      { range: "70–74", mean: "13.8 s", percentUnable: "16.2 %" },
      { range: "75–79", mean: "14.7 s", percentUnable: "23.4 %" },
      { range: "80–84", mean: "15.1 s", percentUnable: "34.4 %" },
      { range: "85–89", mean: "17.2 s", percentUnable: "51.9 %" },
      { range: "≥ 90", mean: "16.4 s", percentUnable: "62.5 %" }
    ];

    // Tromsø Study (Norwegen) Referenzwerte für 5× Sitz-Stand
    const norwegianNorms = {
      "60–69": { mean: 11.4, sd: 1.3, p5: 9.8, p95: 13.0 },
      "70–79": { mean: 12.8, sd: 1.6, p5: 10.8, p95: 14.8 },
      "80–89": { mean: 15.2, sd: 2.1, p5: 12.7, p95: 17.8 },
      "≥ 90":  { mean: 18.4, sd: 3.0, p5: 14.8, p95: 22.0 }
    };

    function calculateSPPB() {
      let balance = 0;
      const tandem = parseFloat(document.getElementById("tandemZeit").value);
      if (document.getElementById("standZusammen").checked) balance += 1;
      if (document.getElementById("semitandem").checked) balance += 1;
      if (!isNaN(tandem)) {
        if (tandem >= 3 && tandem < 10) balance += 1;
        else if (tandem >= 10) balance += 2;
      }

      const dist = parseFloat(document.querySelector('input[name="strecke"]:checked').value);
      const gehzeit = parseFloat(document.getElementById("gehzeit").value);
      let speed = 0, gangScore = 0;
      if (!isNaN(dist) && !isNaN(gehzeit) && gehzeit > 0) {
        speed = dist / gehzeit;
        if (speed <= 0.45) gangScore = 1;
        else if (speed <= 0.64) gangScore = 2;
        else if (speed <= 0.82) gangScore = 3;
        else gangScore = 4;
      }

      const sitzZeit = parseFloat(document.getElementById("sitzStand").value);
      let sitzScore = 0;
      if (isNaN(sitzZeit) || sitzZeit > 60) sitzScore = 0;
      else if (sitzZeit > 16.7) sitzScore = 1;
      else if (sitzZeit >= 13.7) sitzScore = 2;
      else if (sitzZeit >= 11.2) sitzScore = 3;
      else sitzScore = 4;

      const total = balance + gangScore + sitzScore;
      const speedText = (!isNaN(speed)) ? speed.toFixed(2) + " m/s" : "-";

      document.getElementById("result").innerText =
        "Gesamt‑Score: " + total + "/12\n" +
        "Balance: " + balance + "/4\n" +
        "Gang: " + gangScore + "/4\n" +
        "5× Sitz‑Stand: " + sitzScore + "/4\n" +
        "Gehgeschwindigkeit: " + speedText + "\n" +
        "5× Sitz‑Stand Zeit: " + (sitzZeit || "-") + " s";

      document.getElementById("ageSection").classList.remove("hidden");
      document.getElementById("normwerte").classList.add("hidden");
    }

    function toggleNorms() {
      const age = parseInt(document.getElementById("age").value, 10);
      const norms = document.getElementById("normwerte");
      norms.innerHTML = "";

      if (isNaN(age)) {
        norms.innerText = "Bitte zuerst das Alter eingeben.";
        norms.classList.remove("hidden");
        return;
      }

      // --- Mittelwerte Bohannon ---
      norms.appendChild(document.createElement("h4")).innerText = "Mittelwerte Bohannon";
      const tbl1 = document.createElement("table");
      tbl1.innerHTML = "<tr><th>Alter</th><th>5× STS Mittelwert</th><th>% nicht fähig</th></tr>" +
        bohannonNorms.map(row =>
          `<tr><td>${row.range}</td><td>${row.mean}</td><td>${row.percentUnable}</td></tr>`
        ).join("");
      norms.appendChild(tbl1);

      // --- Referenzwerte Norwegen ---
      norms.appendChild(document.createElement("h4")).innerText = "Referenzwerte wohnende Bevölkerung (Norwegen)";
      // Altersspanne finden
      let bracket = null;
      if (age >= 60 && age <= 69) bracket = "60–69";
      else if (age <= 79)            bracket = "70–79";
      else if (age <= 89)            bracket = "80–89";
      else if (age >= 90)            bracket = "≥ 90";

      if (bracket && norwegianNorms[bracket]) {
        const n = norwegianNorms[bracket];
        const tbl2 = document.createElement("table");
        tbl2.innerHTML =
          "<tr><th>Alter</th><th>Mittelwert (s)</th><th>SD (s)</th><th>5. Perzentile</th><th>95. Perzentile</th><th>% besser (Median)</th></tr>" +
          `<tr>
            <td>${bracket}</td>
            <td>${n.mean.toFixed(1)}</td>
            <td>${n.sd.toFixed(1)}</td>
            <td>${n.p5.toFixed(1)}</td>
            <td>${n.p95.toFixed(1)}</td>
            <td>50 %</td>
          </tr>`;
        norms.appendChild(tbl2);
        norms.appendChild(document.createElement("p")).innerText =
          "→ 50 % der Personen in dieser Altersgruppe haben eine schnellere Zeit (Median = 50. Perzentile).";
      } else {
        norms.appendChild(document.createElement("p")).innerText =
          "Keine norwegischen Referenzwerte für das eingegebene Alter verfügbar.";
      }

      norms.classList.remove("hidden");
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.text("SPPB-Auswertung", 10, y); y += 10;
      (document.getElementById("result").innerText || "Noch kein Ergebnis.").split("\n")
        .forEach(line => { doc.text(line, 10, y); y += 7; });

      // Alters‑ und Norm‑Daten
      const age = document.getElementById("age").value;
      if (age) {
        y += 10;
        doc.text(`Alter: ${age}`, 10, y); y += 7;
        const normsText = document.getElementById("normwerte").innerText;
        normsText.split("\n").forEach(line => {
          doc.text(line, 10, y);
          y += 6;
          if (y > 270) { doc.addPage(); y = 10; }
        });
      }
      doc.save("sppb-ergebnis.pdf");
    }
  </script>
</body>
</html>

