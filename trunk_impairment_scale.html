<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trunk Impairment Scale (TIS)</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; font-size: 16px; max-width: 800px; }
    .question { margin-top: 1rem; }
    select { width: 100%; padding: 6px; font-size: 16px; }
    #result { margin-top: 2rem; font-weight: bold; white-space: pre-line; }
    button { margin-top: 20px; padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Trunk Impairment Scale (TIS)</h1>
  <p>Assessment zur Erfassung der Rumpfkontrolle, insbesondere nach Schlaganfall. Die Teststruktur ist dynamisch: bestimmte Items werden nur angezeigt, wenn vorherige bestanden wurden.</p>
  <form id="tisForm"></form>
  <div id="result"></div>
  <button onclick="generatePDF()">ðŸ“„ Als PDF speichern</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const items = [
      {
        text: "1. Patient hÃ¤lt Startposition 10 Sekunden ohne UnterstÃ¼tzung",
        options: [{label:"Nein", value:0}, {label:"Ja", value:2}],
        section: "static",
        followIf: 2
      },
      {
        text: "2. Therapeut kreuzt nicht-betroffenes Bein Ã¼ber hemiplegisches Bein",
        options: [
          {label:"FÃ¤llt oder kann Position nicht 10â€¯Sek halten ohne ArmunterstÃ¼tzung", value:0},
          {label:"HÃ¤lt Position 10â€¯Sek", value:2}
        ],
        section: "static",
        followIf: null
      },
      {
        text: "3. Patient kreuzt selbst nicht-betroffenes Bein Ã¼ber hemiplegisches Bein",
        options: [
          {label:"FÃ¤llt", value:0},
          {label:"Kann nicht ohne Armhilfe kreuzen", value:1},
          {label:"Kreuzt mit >10â€¯cm RÃ¼cklage oder Hilfe", value:2},
          {label:"Kreuzt ohne Hilfe oder RÃ¼cklage", value:3}
        ],
        section: "static",
        followIf: null
      },
      {
        text: "4. Patient berÃ¼hrt mit hemiplegischem Ellenbogen die Liege/Tisch",
        options: [
          {label:"FÃ¤llt, braucht Hilfe oder Ellenbogen berÃ¼hrt nicht", value:0},
          {label:"Bewegt sich aktiv, Ellenbogen berÃ¼hrt Liege", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "5. Wiederholung Item 4 â€“ VerkÃ¼rzung/VerlÃ¤ngerung angemessen",
        options: [
          {label:"Nein oder gegenteilig", value:0},
          {label:"Ja, angemessen", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "6. Wiederholung Item 4 â€“ Bewegung ohne Kompensation",
        options: [
          {label:"Kompensation (z.B. Arm, HÃ¼fte, Knie, FuÃŸ)", value:0},
          {label:"Bewegung ohne Kompensation", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "7. Patient berÃ¼hrt mit nicht-hemiplegischem Ellenbogen die Liege/Tisch",
        options: [
          {label:"FÃ¤llt, braucht Hilfe oder Ellenbogen berÃ¼hrt nicht", value:0},
          {label:"Bewegt sich aktiv, Ellenbogen berÃ¼hrt Liege", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "8. Wiederholung Item 7 â€“ VerkÃ¼rzung/VerlÃ¤ngerung angemessen",
        options: [
          {label:"Nein oder gegenteilig", value:0},
          {label:"Ja, angemessen", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "9. Wiederholung Item 7 â€“ Bewegung ohne Kompensation",
        options: [
          {label:"Kompensation (z.B. Arm, HÃ¼fte, Knie, FuÃŸ)", value:0},
          {label:"Bewegung ohne Kompensation", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "10. Patient hebt Becken hemiplegisch Seite â€“ RÃ¼ckkehr",
        options: [
          {label:"Keine oder gegenteilige Bewegung", value:0},
          {label:"Angemessene VerkÃ¼rzung/VerlÃ¤ngerung", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "11. Wiederholung Item 10 â€“ ohne Kompensation",
        options: [
          {label:"Kompensation (Arm, FuÃŸ)", value:0},
          {label:"Bewegung ohne Kompensation", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "12. Patient hebt Becken nicht-hemiplegisch Seite â€“ RÃ¼ckkehr",
        options: [
          {label:"Keine oder gegenteilige Bewegung", value:0},
          {label:"Angemessene VerkÃ¼rzung/VerlÃ¤ngerung", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "13. Wiederholung Item 12 â€“ ohne Kompensation",
        options: [
          {label:"Kompensation (Arm, FuÃŸ)", value:0},
          {label:"Bewegung ohne Kompensation", value:1}
        ],
        section: "dynamic",
        followIf: 1
      },
      {
        text: "14. OberkÃ¶rperrotation 6Ã— (hemiplegische Seite zuerst, Kopf fixiert)",
        options: [
          {label:"Hemiplegische Seite nicht 3Ã— bewegt", value:0},
          {label:"Asymmetrisch", value:1},
          {label:"Symmetrisch", value:2}
        ],
        section: "coordination",
        followIf: null
      },
      {
        text: "15. Wiederholung Item 14 innerhalb 6â€¯Sekunden",
        options: [
          {label:"Asymmetrisch", value:0},
          {label:"Symmetrisch", value:1}
        ],
        section: "coordination",
        followIf: null
      },
      {
        text: "16. UnterkÃ¶rperrotation 6Ã— (hemiplegische Seite zuerst, OberkÃ¶rper fixiert)",
        options: [
          {label:"Hemiplegische Seite nicht 3Ã— bewegt", value:0},
          {label:"Asymmetrisch", value:1},
          {label:"Symmetrisch", value:2}
        ],
        section: "coordination",
        followIf: null
      },
      {
        text: "17. Wiederholung Item 16 innerhalb 6â€¯Sekunden",
        options: [
          {label:"Asymmetrisch", value:0},
          {label:"Symmetrisch", value:1}
        ],
        section: "coordination",
        followIf: null
      }
    ];

    let responses = [];
    const form = document.getElementById("tisForm");

    function renderForm() {
      form.innerHTML = "";
      responses.forEach((val, i) => {
        const item = items[i];
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `<label>${item.text}</label>
          <select onchange="handleChange(${i}, this.value)">
            <option value="">Antwort auswÃ¤hlen</option>
            ${item.options.map((opt, idx) => `<option value="${opt.value}">${opt.label}</option>`).join("")}
          </select>`;
        form.appendChild(div);
        if (val !== null) form.querySelectorAll("select")[i].value = val;
      });
      updateResult();
    }

    function handleChange(index, value) {
      responses[index] = parseInt(value);
      // Dynamik prÃ¼fen
      let nextIndex = index + 1;
      while (nextIndex < items.length) {
        const prevItem = items[nextIndex - 1];
        const nextItem = items[nextIndex];
        if (nextItem.followIf !== null && responses[nextIndex - 1] !== nextItem.followIf) {
          responses = responses.slice(0, nextIndex);
          break;
        }
        responses.push(null);
        break;
      }
      renderForm();
    }

    function updateResult() {
      const scores = { static: 0, dynamic: 0, coordination: 0 };
      const max = { static: 5, dynamic: 10, coordination: 6 };

      for (let i = 0; i < responses.length; i++) {
        const item = items[i];
        const val = responses[i];
        if (val !== null && !isNaN(val)) scores[item.section] += val;
      }

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML =
        `Gesamtscore: ${scores.static + scores.dynamic + scores.coordination} / ${max.static + max.dynamic + max.coordination}\n` +
        `Statische Balance: ${scores.static} / ${max.static}\n` +
        `Dynamische Balance: ${scores.dynamic} / ${max.dynamic}\n` +
        `Koordination: ${scores.coordination} / ${max.coordination}`;
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;

      doc.setFontSize(16);
      doc.text("Trunk Impairment Scale (TIS)", 10, y);
      y += 10;

      for (let i = 0; i < responses.length; i++) {
        doc.setFontSize(12);
        const item = items[i];
        const response = responses[i];
        const label = item.options.find(opt => opt.value === response)?.label || "-";
        doc.text(`${i + 1}. ${item.text}`, 10, y); y += 6;
        doc.text(`Antwort: ${label}`, 10, y); y += 8;
        if (y > 270) { doc.addPage(); y = 10; }
      }

      const total = responses.reduce((a, b) => a + (b || 0), 0);
      doc.setFontSize(14);
      doc.text(`Gesamtscore: ${total} / 21`, 10, y);
      window.open(doc.output('bloburl'), '_blank');
    }

    responses.push(null);
    renderForm();
  </script>
</body>
</html>
